{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4 text-gray-100">MagangHub Filter</h1>

  <form method="get" class="mb-6">
    <div class="space-y-2">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block mb-1 text-gray-300">Province (multi-select)</label>
          <div>
            <input id="prov-search" type="text" placeholder="Search province..." class="w-full mb-2 p-2 bg-gray-900 border border-gray-700 rounded text-gray-200" />
            <div id="prov-container" class="w-full p-2 bg-gray-800 border border-gray-700 rounded h-32 overflow-auto">
              {% for folder,label in prov_choices %}
                <label class="block text-gray-200">
                  <input type="checkbox" name="prov" value="{{ folder }}" {% if folder in selected_provs %}checked{% endif %}>
                  <span class="ml-2">{{ label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <div>
          <label class="block mb-1 text-gray-300">Kabupaten (multi-select)</label>
          <div>
            <input id="kab-search" type="text" placeholder="Search kabupaten..." class="w-full mb-2 p-2 bg-gray-900 border border-gray-700 rounded text-gray-200" />
            <div id="kab-container" class="w-full p-2 bg-gray-800 border border-gray-700 rounded h-32 overflow-auto">
              {% for k in kab_choices %}
                <label class="block text-gray-200">
                  <input type="checkbox" name="kabupaten" value="{{ k }}" {% if k in selected_kabs %}checked{% endif %}>
                  <span class="ml-2">{{ k }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <div>
          <label class="block mb-1 text-gray-300">Government / Non-government</label>
          <div id="gov-container" class="w-full p-2 bg-gray-800 border border-gray-700 rounded h-24 overflow-auto">
            {% for val,label in gov_options %}
              <label class="block text-gray-200">
                <input type="checkbox" name="gov" value="{{ val }}" {% if val in selected_govs %}checked{% endif %}>
                <span class="ml-2">{{ label }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <div class="flex-1">
          <label class="text-gray-300">Program Studi (substring)</label>
          <input type="text" name="program_studi" value="{{ program_studi_q }}" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-gray-100" placeholder="e.g. Teknik Informatika">
        </div>
        <div class="flex-1">
          <label class="text-gray-300">Keywords (search in description, OR tokens)</label>
          <input type="text" name="keywords" value="{{ keywords_q }}" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-gray-100" placeholder="e.g. python html css">
        </div>
        <div class="w-40">
          <label class="text-gray-300">Short</label>
          <select name="short" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-gray-100">
            <option value="1" {% if short_mode == '1' %}selected{% endif %}>Percent (accept)</option>
            <option value="2" {% if short_mode == '2' %}selected{% endif %}>Kuota</option>
            <option value="3" {% if short_mode == '3' %}selected{% endif %}>Terdaftar</option>
          </select>
        </div>
      </div>

      <div>
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-400">Search</button>
      </div>
    </div>
  </form>

  {% if error %}
    <div class="text-red-600">Error: {{ error }}</div>
  {% endif %}

  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-gray-100">Results ({{ results|length }})</h2>
      <div class="text-sm text-gray-400">Sorted by: {% if short_mode == '1' %}Accept{% elif short_mode == '2' %}Kuota{% else %}Terdaftar{% endif %}</div>
    </div>
    {% if results %}
      <!-- Desktop table (large screens) -->
      <div class="hidden lg:block overflow-x-auto">
        <table class="min-w-full bg-transparent border border-gray-700">
          <thead>
            <tr class="bg-gray-800 text-left text-gray-200">
              <th class="px-4 py-2 border-b border-gray-700">Posisi</th>
              <th class="px-4 py-2 border-b border-gray-700">Perusahaan</th>
              <th class="px-4 py-2 border-b border-gray-700">Kabupaten</th>
              <th class="px-4 py-2 border-b border-gray-700">Provinsi</th>
              <th class="px-4 py-2 border-b border-gray-700">Program Studi</th>
              <th class="px-4 py-2 border-b border-gray-700">Jenjang</th>
              <th class="px-4 py-2 border-b border-gray-700">{% if short_mode == '1' %}Accept{% elif short_mode == '2' %}Kuota{% else %}Terdaftar{% endif %}</th>
              <th class="px-4 py-2 border-b border-gray-700">Link</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results %}
              <tr class="odd:bg-gray-900 even:bg-gray-800">
                <td class="px-4 py-2 border-t border-gray-700 align-top">
                  <div class="font-semibold text-gray-100">{{ item.posisi }}</div>
                  {% if item.deskripsi_posisi %}
                    <div class="text-sm text-gray-400">{{ item.deskripsi_posisi|truncatechars:120 }}</div>
                  {% endif %}
                </td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.perusahaan }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.nama_kabupaten }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.nama_provinsi }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.program_studi }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.jenjang }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top text-gray-100">{{ item.short }}</td>
                <td class="px-4 py-2 border-t border-gray-700 align-top">
                  {% if item.id_posisi %}
                    <a target="_blank" rel="noopener" class="text-blue-300 underline" href="https://maganghub.kemnaker.go.id/lowongan/view/{{ item.id_posisi }}">View</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile cards -->
      <div class="space-y-4 lg:hidden">
        {% for item in results %}
          <div class="bg-gray-800 border border-gray-700 rounded p-4">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-gray-100">{{ item.posisi }}</div>
                <div class="text-sm text-gray-400">{{ item.perusahaan }} â€” {{ item.nama_kabupaten }}, {{ item.nama_provinsi }}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-200">{{ item.short }}</div>
                <div class="text-xs text-gray-400">{{ item.accept_pct }}</div>
              </div>
            </div>
            <div class="mt-2 text-sm text-gray-400">{{ item.program_studi }}</div>
            <div class="mt-3">
              {% if item.id_posisi %}
                <a target="_blank" rel="noopener" class="inline-block px-3 py-1 bg-blue-500 text-white rounded" href="https://maganghub.kemnaker.go.id/lowongan/view/{{ item.id_posisi }}">View</a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-gray-400">No results</div>
    {% endif %}
  </div>
</div>
  <script>
  // prov_to_kabs_json injected by view (escaped). Parse it and use to update kabupaten options
  (function(){
    try {
      const provToKabs = JSON.parse('{{ prov_to_kabs_json|escapejs }}' || '{}');
      const provContainer = document.getElementById('prov-container');
      const kabContainer = document.getElementById('kab-container');
      const provSearch = document.getElementById('prov-search');
      const kabSearch = document.getElementById('kab-search');
      if (!provContainer || !kabContainer) return;

      function getCheckedProvs(){
        return Array.from(provContainer.querySelectorAll('input[name="prov"]:checked')).map(i=>i.value);
      }

      function getCheckedKabs(){
        return Array.from(kabContainer.querySelectorAll('input[name="kabupaten"]:checked')).map(i=>i.value);
      }

      function filterCheckboxes(container, query){
        const q = (query||'').trim().toLowerCase();
        Array.from(container.querySelectorAll('label')).forEach(label => {
          const text = (label.textContent || '').trim().toLowerCase();
          label.style.display = (q === '' || text.indexOf(q) !== -1) ? '' : 'none';
        });
      }

      function updateKabOptions(){
        const selectedProv = getCheckedProvs();
        const kabSet = new Set();
        selectedProv.forEach(p => {
          (provToKabs[p] || []).forEach(k => kabSet.add(k));
        });
        const options = Array.from(kabSet).sort((a,b)=> a.localeCompare(b));

        // preserve previous selections when possible
        const prev = new Set(getCheckedKabs());

        // rebuild checkboxes
        kabContainer.innerHTML = '';
        options.forEach(k => {
          const label = document.createElement('label');
          label.className = 'block text-gray-200';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.name = 'kabupaten';
          input.value = k;
          if (prev.has(k)) input.checked = true;
          const span = document.createElement('span');
          span.className = 'ml-2';
          span.textContent = k;
          label.appendChild(input);
          label.appendChild(span);
          kabContainer.appendChild(label);
        });

        // apply current kab search filter after rebuilding
        if (kabSearch) filterCheckboxes(kabContainer, kabSearch.value);
      }

      // attach listeners to existing province checkboxes
      provContainer.querySelectorAll('input[name="prov"]').forEach(cb => cb.addEventListener('change', updateKabOptions));

      // live-search for province list
      if (provSearch) provSearch.addEventListener('input', function(){ filterCheckboxes(provContainer, this.value); });
      // live-search for kabupaten list
      if (kabSearch) kabSearch.addEventListener('input', function(){ filterCheckboxes(kabContainer, this.value); });

      // initial sync + apply initial searches (if any)
      updateKabOptions();
      if (provSearch) filterCheckboxes(provContainer, provSearch.value);
      if (kabSearch) filterCheckboxes(kabContainer, kabSearch.value);
    } catch (e) {
      console.warn('prov->kab update failed', e);
    }
  })();
  </script>
{% endblock %}
